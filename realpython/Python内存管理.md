> 原文链接：https://realpython.com/python-memory-management/
>
> 发布时间：2018-11-21
>
> 作者：Alexander VanTol
>
> 译者：Roger Lee



### 目录

- 内存是一本空白的书
- 内存管理：从硬件至软件
- 默认的Python实现
- 解释器全局锁（GIL）
- 垃圾回收机制
- CPython的内存管理
  - 内存池（pools）
  - 内存块（blocks）
  - Arenas
- 总结



你是否好奇Python如何在后台处理你的数据？如何在内存中存储你的变量？它们什么时候会被删除掉吗？

在本篇文章中，我们将会深处Python内部去了解它如何进行内存管理。



**读完本篇文章后，你将：**

- 学习更多关于底层计算的内容，特别是于内存有关的。
- 理解Python是如何抽象化底层操作
- 学习更多关于Python内部内存管理机制的算法

了解Python的内部将有助于你对一些Python的行为有更好的见解。同时也希望你能够对Python有一个新的认识。在运行的背后有很多逻辑确保你的程序能够如你所期待的那样实现。



## 内存是一本空白的书

你现在可以想象计算机的内存就如同一本空白的书，用于写上简短的小故事，尚未在任何一页纸写东西。之后，随着不同作者的到来，每一位作者想要一些空白的地方写上他们的故事。

由于他们不允许去修改别人的内容，所以他们必须要小心翼翼的注意他们所书写的页面。在开始写作之前，他们必须要先询问该书的管理员。然后管理员决定他们允许书写的地方。

因为这本书由来已久，许多书中的一些故事也不再有任何关联。当没有人阅读或者引用故事时，这些故事就会被删除，腾出空间给新的故事。

本质上，计算机的内存就像是那本空白的书。其实通常称为固定长度的连续**内存页**（memory pages），这个比喻非常切当。

书的作者更像是不同的应用或者进程，它们需要将数据存在内存里。而那个决定作者可以使用书中哪些空间的管理员，扮演着内存管理员的角色。那个把旧故事删除腾出空间给新故事的人则是一个垃圾回收员。



## 内存管理：从硬件至软件

内存管理是一个处理应用数据读写的过程。一个内存管理决定在哪里存放应用的数据。但是由于内存块是有限的，就像我们比喻的书的纸张一样，管理员需要找到可用空间并且提供给应用使用。这个将内存提供使用的过程通常被称为内存**分配**（memory allocation）。

另一方面，当数据已经不再被使用时，它就可以被删除或者被释放。但是释放到哪里去？这个“内存”又是从何而来呢？

当你运行Python程序时，在计算机的某个地方，有一个物理设备用于存储数据。然而在对象去到硬件前，Python代码需要经过许许多多的抽象层。

其中一个主要的层就是位于硬件（例如RAM或者一个硬盘驱动器）上层的操作系统，简称OS。它根据要求去执行（或者拒绝）读写内存。

在操作系统之上就是应用程序，其中一个就是默认的Python实现（被预先安装在你的操作系统或者从python.org下载安装的）。你代码的内存管理是由Python应用进行处理。Python进行内存管理的算法和结构将是本文主要关注的内容。



## 默认的Python实现

默认的Python实现是CPython，其是由C语言编写的。当我第一次听说时，我感到非常震惊，一门语言竟然使用另一门语言来写？！不过也不完全是了，但是差不多了。

在用英文编写的官方参考手册<sup>[1]</sup>中对Python语言进行了定义。然而，该参考手册并不是那么有用，因为你还是需要自己根据手册中的规则去解释Python代码。

而且你还需要在一台计算机上实际的执行已解释的代码。默认的Python实现可以满足这两个需求。它将你的Python代码转换成指令，之后就可以在一台虚拟机（ virtual machine）上面运行。

> 虚拟机和物理计算机差不多，但是它们是使用软件实现的。它们通常处理基本的指令，与汇编指令<sup>[2]</sup>相似。

Python是一门解释性编程语言。你的Python代码实际上编译成更为计算机可读的指令，称为字节码<sup>[3]</sup>（bytecode）。这些指令在你运行代码后就会被一个虚拟机解释。

你是否有曾见过一个`.pyc`文件或者`__pycache__`文件夹？这些就是被虚拟机解释过的字节码。

值得注意的是，除了CPython这个实现，还有其他不同的Python实现。IronPython<sup>[4]</sup>把代码编译成可在微软公共语言运行时（Common Language Runtime）运行。Jython<sup>[5]</sup>把代码编译成Java字节码用于在Java虚拟机运行。最后是PyPy<sup>[6]</sup>，不过它得用整整一篇文章来写，所以这里我就提及一下足以。

对于编写本篇文章的目的，我会专注于CPython作为Python默认实现时内存的管理机制。

> 免责声明：因为所有这些信息是基于现在Python的最新版本，有些东西将来可能会改变。所以要注意的是，这篇文章使用的是当前最新的Python版本  3.7<sup>[7]</sup>。

好吧，所以CPython是使用C语言编写，它解释Python字节码。但是这和内存管理有什么关系吗？其实，内存管理的算法和结构就存在于CPython的代码之中， 在C语言代码里。要理解Python的内存管理，那你就得对CPython本身有一个基本的了解。

CPython使用C语言编写，其本身原生不并支持面向对象编程。就因为这样，在CPython代码里面有非常多有趣的设计。

你可能听说过，在Python里面一切皆是对象，甚至连类型`int`和`str`也是如此。在CPython的实现层面上确实如此。有一个`struct`类型叫`PyObject`，这是在CPython中的每一个对象都使用的。

> 注意：struct 或者结构体，在C语言中是一种自定义的数据类型，可以将一些有关的不同类型变量组织起来构造成一个结构体。与面向对象编程语言相比，它就像是class里的属性，但是没有编写方法。

